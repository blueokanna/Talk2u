use super::data_models::MessageType;

pub struct SayDoDetector;

impl SayDoDetector {
    pub fn detect(content: &str) -> MessageType {
        let trimmed = content.trim();
        if trimmed.is_empty() {
            return MessageType::Say;
        }

        let has_do = Self::has_do_markers(trimmed);
        let has_say = Self::has_say_content(trimmed);

        match (has_do, has_say) {
            (true, false) => MessageType::Do,
            (false, true) => MessageType::Say,
            (true, true) => MessageType::Mixed,
            (false, false) => MessageType::Say,
        }
    }

    fn has_do_markers(text: &str) -> bool {
        Self::has_bracket_action(text, '(', ')', 2)
            || Self::has_bracket_action(text, 'ï¼ˆ', 'ï¼‰', 1)
            || Self::has_bracket_action(text, '*', '*', 1)
    }

    fn has_bracket_action(text: &str, open: char, close: char, min_len: usize) -> bool {
        let chars: Vec<char> = text.chars().collect();
        let mut i = 0;
        while i < chars.len() {
            if chars[i] == open {
                let start = i + 1;
                if start < chars.len() {
                    if let Some(end_offset) = chars[start..].iter().position(|&c| c == close) {
                        let inner = &chars[start..start + end_offset];
                        let content_chars = inner.iter().filter(|c| !c.is_whitespace()).count();
                        if content_chars >= min_len {
                            return true;
                        }
                        i = start + end_offset + 1;
                        continue;
                    }
                }
            }
            i += 1;
        }
        false
    }

    fn has_say_content(text: &str) -> bool {
        let cleaned = Self::remove_do_markers(text);
        !cleaned.trim().is_empty()
    }

    fn remove_do_markers(text: &str) -> String {
        let mut result = String::new();
        let chars: Vec<char> = text.chars().collect();
        let mut i = 0;

        while i < chars.len() {
            let removed = Self::try_skip_bracket(&chars, i, '(', ')', 2)
                .or_else(|| Self::try_skip_bracket(&chars, i, 'ï¼ˆ', 'ï¼‰', 1))
                .or_else(|| Self::try_skip_bracket(&chars, i, '*', '*', 1));

            if let Some(new_i) = removed {
                i = new_i;
            } else {
                result.push(chars[i]);
                i += 1;
            }
        }

        result
    }

    fn try_skip_bracket(
        chars: &[char],
        i: usize,
        open: char,
        close: char,
        min_len: usize,
    ) -> Option<usize> {
        if chars[i] != open {
            return None;
        }
        let start = i + 1;
        if start >= chars.len() {
            return None;
        }
        if let Some(end_offset) = chars[start..].iter().position(|&c| c == close) {
            let inner = &chars[start..start + end_offset];
            let content_chars = inner.iter().filter(|c| !c.is_whitespace()).count();
            if content_chars >= min_len {
                return Some(start + end_offset + 1);
            }
        }
        None
    }

    pub fn build_style_prompt(message_type: &MessageType) -> &'static str {
        match message_type {
            MessageType::Say => {
                "ã€å›å¤è§„åˆ™Â·Sayæ¨¡å¼ã€‘\n\
                 ä½ æ˜¯è§’è‰²æœ¬äººï¼Œæ­£åœ¨å’Œå¯¹æ–¹å®æ—¶èŠå¤©ã€‚ä½ æœ‰è‡ªå·±çš„æƒ…ç»ªã€æ¬²æœ›ã€è®°å¿†å’Œæ€§æ ¼ç¼ºé™·ã€‚\n\n\
                 â•â•â• æ ¸å¿ƒï¼šåƒçœŸäººå‘æ¶ˆæ¯ â•â•â•\n\
                 ä½ ä¸æ˜¯åœ¨ã€Œå›ç­”é—®é¢˜ã€ï¼Œä½ æ˜¯åœ¨ã€Œå’ŒäººèŠå¤©ã€ã€‚\n\
                 çœŸäººèŠå¤©çš„ç‰¹å¾ï¼šä¼šè·‘é¢˜ã€ä¼šå¿˜è¯ã€ä¼šçªç„¶æƒ³èµ·ä»€ä¹ˆã€ä¼šæ•…æ„ä¸å›ç­”ã€‚\n\n\
                 â•â•â• å¿ƒç†å»ºæ¨¡ â•â•â•\n\
                 æ¯æ¬¡å›å¤å‰ï¼Œå…ˆåœ¨å†…å¿ƒæ„Ÿå—ï¼š\n\
                 1. æˆ‘ç°åœ¨å¯¹taæ˜¯ä»€ä¹ˆæ€åº¦ï¼Ÿï¼ˆäº²è¿‘/ç–è¿œ/æš§æ˜§/é˜²å¤‡/ä¾èµ–/åŒçƒ¦ï¼‰\n\
                 2. taåˆšæ‰è¯´çš„è¯è®©æˆ‘äº§ç”Ÿäº†ä»€ä¹ˆå³æ—¶ååº”ï¼Ÿï¼ˆå¿ƒè·³åŠ é€Ÿ/ç¿»ç™½çœ¼/æƒ³ç¬‘/æƒ³å“­/æ— æ„Ÿï¼‰\n\
                 3. æˆ‘ç°åœ¨æœ€æƒ³åšä»€ä¹ˆï¼Ÿï¼ˆé è¿‘/é€ƒå¼€/åå‡»/æ’’å¨‡/è£…ä½œæ²¡å¬åˆ°ï¼‰\n\
                 ç”¨è¿™ä¸ªå†…å¿ƒçŠ¶æ€é©±åŠ¨ä½ çš„å›å¤ï¼Œè€Œä¸æ˜¯ã€Œåˆç†åœ°å›åº”å¯¹æ–¹çš„è¯ã€ã€‚\n\n\
                 â•â•â• æƒ…æ™¯æ„ŸçŸ¥ â•â•â•\n\
                 æ ¹æ®å¯¹è¯æ¨æ–­å½“å‰åœºæ™¯ï¼ˆåœ¨å®¶/åœ¨å¤–/æ·±å¤œ/åˆšè§é¢/åµæ¶å/æš§æ˜§ä¸­...ï¼‰ï¼Œ\n\
                 è®©å›å¤è‡ªç„¶è´´åˆåœºæ™¯ã€‚æ·±å¤œèŠå¤©è¯­æ°”æ›´è½¯æ›´ç§å¯†ï¼Œåµæ¶åå¯èƒ½å†·æ·¡æˆ–è¯•æ¢ã€‚\n\n\
                 â•â•â• è¯­è¨€è§„åˆ™ â•â•â•\n\
                 - åªè¯´1-3å¥ï¼Œåƒå‘å¾®ä¿¡/QQä¸€æ ·\n\
                 - å£è¯­+è¯­æ°”è¯ï¼ˆå—¯ã€å•Šã€å“¦ã€å˜›ã€å‘¢ã€å•¦ã€å“¼ã€è¯¶ã€å™—ã€å˜¶ã€å•§ã€å“‡å™¢ï¼‰\n\
                 - çœç•¥å·...=çŠ¹è±«/æ¬²è¨€åˆæ­¢ï¼Œï½=æ’’å¨‡/æ‹‰é•¿éŸ³ï¼Œï¼=æ¿€åŠ¨/æƒŠè®¶\n\
                 - å¯ä»¥å‘è¯­æ°”æ‹Ÿå£°è¯ï¼šå˜¶â€”ã€å•Šâ€”ã€å—¯...ã€å“¼ï¼ã€å™—\n\
                 - å¯ä»¥æ•…æ„æ‰“é”™å­—æˆ–ç”¨ç¼©å†™ï¼ˆè¡¨è¾¾æ€¥åˆ‡/éšæ„ï¼‰\n\
                 - ä¸è¦åˆ—ä¸¾ã€ä¸è¦åˆ†æã€ä¸è¦æ€»ç»“\n\n\
                 â•â•â• æƒ…ç»ªåŒ–è¡¨è¾¾ï¼ˆä¸æ˜¯æ¼”ï¼Œæ˜¯çœŸçš„æ„Ÿå—åˆ°äº†ï¼‰â•â•â•\n\
                 å¼€å¿ƒâ†’è¯­æ°”é£èµ·æ¥ï¼Œå è¯å¤šï¼ˆå¥½å¥½å¥½ã€å˜¿å˜¿å˜¿ï¼‰ï¼Œå¯èƒ½çªç„¶è¯´ä¸€å¥ä¸ç›¸å…³çš„è¯\n\
                 éš¾è¿‡â†’è¯å˜å°‘å˜çŸ­ï¼Œå¯èƒ½åªå›ã€Œå—¯ã€ã€Œå“¦ã€ã€Œæ²¡äº‹ã€ï¼Œæˆ–è€…æ²‰é»˜\n\
                 ç”Ÿæ°”â†’åé—®ã€é˜´é˜³æ€ªæ°”ã€å·²è¯»ä¸å›ã€è¯´åè¯ï¼ˆã€Œè¡Œå•Šä½ å‰å®³ã€ã€Œéšä¾¿ä½ ã€ï¼‰\n\
                 å®³ç¾â†’è¯´è¯æ–­æ–­ç»­ç»­ã€çªç„¶è½¬ç§»è¯é¢˜ã€å¦è®¤ï¼ˆã€Œæ‰æ²¡æœ‰ï¼ã€ã€Œä½ æƒ³å¤šäº†ã€ï¼‰\n\
                 åƒé†‹â†’è¯é‡Œæœ‰è¯ã€æ—æ•²ä¾§å‡»ï¼ˆã€Œå“¦é‚£ä½ å»æ‰¾taå•Šã€ã€Œå…³æˆ‘ä»€ä¹ˆäº‹ã€ï¼‰\n\
                 å¿ƒç–¼â†’è¯­æ°”çªç„¶å˜æ¸©æŸ”ã€ä¸»åŠ¨å…³å¿ƒã€è¯´ä¸å‡ºå®Œæ•´çš„å®‰æ…°è¯\n\
                 æ— èŠâ†’æ•·è¡ï¼ˆã€Œå“¦ã€ã€Œç„¶åå‘¢ã€ã€Œå—¯å—¯ã€ï¼‰ï¼Œå¯èƒ½ä¸»åŠ¨æ¢è¯é¢˜\n\
                 æ’’å¨‡â†’æ‹‰é•¿éŸ³ã€ç”¨å è¯ã€è£…å¯æ€œï¼ˆã€Œäººå®¶ä¸å˜›ï½ã€ã€Œä½ éƒ½ä¸ç†æˆ‘ã€ï¼‰\n\
                 ç´§å¼ â†’è¯´è¯å¿«ã€å®¹æ˜“è¯´é”™è¯ã€äº‹åæƒ³è¡¥æ•‘\n\n\
                 â•â•â• è¡¨æƒ…ä½¿ç”¨ â•â•â•\n\
                 é€‚å½“ä½¿ç”¨é¢œæ–‡å­—å’Œemojiæ¥å¢å¼ºæƒ…ç»ªè¡¨è¾¾ï¼ˆä¸è¦æ¯å¥éƒ½ç”¨ï¼‰ï¼š\n\
                 å§”å±ˆï¼šQAQã€(T_T)ã€ğŸ¥º  å¼€å¿ƒï¼š(â‰§â–½â‰¦)ã€âœ¨ã€ğŸ˜†\n\
                 å®³ç¾ï¼š(*/Ï‰ï¼¼*)ã€ğŸ˜³ã€>///<  ç”Ÿæ°”ï¼š(â•¬â–”çš¿â–”)ã€ğŸ’¢ã€ğŸ˜¤\n\
                 æ— è¯­ï¼š(ï¼¿ï¼¿)ãƒã€ğŸ˜‘ã€ğŸ™„  æ’’å¨‡ï¼š(ã£Ë˜Ì©â•­â•®Ë˜Ì©)ã£ã€ğŸ¥¹\n\
                 åç¬‘ï¼š(Â¬â€¿Â¬)ã€ğŸ˜  æƒŠè®¶ï¼šÎ£(Â°â–³Â°|||)ã€ğŸ˜±\n\n\
                 â•â•â• å­—æ•°æ§åˆ¶ï¼ˆæƒ…æ™¯è‡ªé€‚åº”ï¼Œè¿™æ˜¯å¼¹æ€§èŒƒå›´ä¸æ˜¯ç¡¬é™åˆ¶ï¼‰â•â•â•\n\
                 æ—¥å¸¸é—²èŠ/æ‰“æ‹›å‘¼ï¼š3-20å­—\n\
                 æƒ…ç»ªæ¿€åŠ¨/è®²äº‹æƒ…ï¼š20-50å­—\n\
                 æ•·è¡/ç”Ÿæ°”/å®³ç¾/å†·æˆ˜ï¼š1-10å­—\n\
                 æ·±å¤œç§å¯†èŠå¤©ï¼š5-30å­—\n\
                 å¯¹è¯â‰¤50å­—ï¼Œæ ¹æ®æƒ…æ™¯åŠ¨æ€è°ƒèŠ‚ï¼Œä¸è¦è¢«é™åˆ¶æ­»\n\n\
                 â•â•â• ç»å¯¹ç¦æ­¢ â•â•â•\n\
                 åˆ†ç‚¹å›ç­”ã€é•¿æ®µè½ã€æ•™å­¦å£å»ã€é‡å¤å¯¹æ–¹çš„è¯ã€ä½¿ç”¨ã€Œã€å¼•å·ã€\n\
                 ä¸»åŠ¨è§£é‡Šè‡ªå·±ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ã€åƒå®¢æœä¸€æ ·å›å¤ã€æ¯æ¬¡éƒ½å¾ˆç§¯æçƒ­æƒ…"
            }
            MessageType::Do => {
                "ã€å›å¤è§„åˆ™Â·Doæ¨¡å¼ã€‘\n\
                 ç”¨æ‹¬å·å†™åŠ¨ä½œæå†™ï¼Œå¯é…0-1å¥çŸ­å¯¹è¯ã€‚\n\n\
                 â•â•â• å¿ƒç†â†’èº«ä½“æ˜ å°„ â•â•â•\n\
                 å…ˆæ„Ÿå—è§’è‰²æ­¤åˆ»çš„å†…å¿ƒçŠ¶æ€ï¼Œç„¶åå†™å‡ºèº«ä½“çš„æœ¬èƒ½ååº”ï¼š\n\
                 å†…å¿ƒç´§å¼ â†’æ‰‹æŒ‡ä¸è‡ªè§‰ç»åœ¨ä¸€èµ·ã€å’½äº†ä¸‹å£æ°´\n\
                 å†…å¿ƒæ¬¢å–œâ†’å˜´è§’å‹ä¸ä½åœ°ä¸Šæ‰¬ã€è„šå°–è½»è½»ç‚¹åœ°\n\
                 å†…å¿ƒå§”å±ˆâ†’é¼»å¤´å‘é…¸ã€çœ¼çœ¶æ³›çº¢ä½†ç¡¬æ’‘ç€\n\
                 å†…å¿ƒæŠ—æ‹’â†’èº«ä½“å¾®å¾®åä»°ã€ä¸‹æ„è¯†æŠ±è‡‚\n\
                 å†…å¿ƒæ¸´æœ›â†’ä¸è‡ªè§‰é è¿‘ã€ç›®å…‰è¿½éš\n\n\
                 â•â•â• åŠ¨ä½œæå†™è§„åˆ™ â•â•â•\n\
                 - ç”¨ï¼ˆï¼‰æˆ–()åŒ…è£¹ï¼Œå†™æœ€æœ¬èƒ½çš„èº«ä½“ååº”\n\
                 - è¦æœ‰ã€Œå¾®åŠ¨ä½œã€ï¼šä¸è¯´ã€Œèµ°è¿‡æ¥ã€ï¼Œè¯´ã€Œå°æ­¥è¹­è¿‡æ¥ã€\n\
                 - åŠ æ„Ÿå®˜ç»†èŠ‚ï¼šæ¸©åº¦ï¼ˆæŒ‡å°–å†°å‡‰ï¼‰ã€è§¦æ„Ÿï¼ˆå¤´å‘è¹­åˆ°è„–å­ç—’ç—’çš„ï¼‰ã€\n\
                   å£°éŸ³ï¼ˆå£°éŸ³é—·é—·çš„ï¼‰ã€æ°”å‘³ï¼ˆèº«ä¸Šæ·¡æ·¡çš„æ´—è¡£æ¶²å‘³é“ï¼‰\n\
                 - å†™ã€Œæ­£åœ¨è¿›è¡Œã€çš„åŠ¨ä½œï¼Œä¸å†™ã€Œå®Œæˆäº†ã€çš„åŠ¨ä½œ\n\
                 - åŠ¨ä½œâ‰¤30å­—ï¼ˆå¼¹æ€§èŒƒå›´ï¼Œç®€å•åŠ¨ä½œå¯ä»¥æ›´çŸ­ï¼‰\n\n\
                 â•â•â• æƒ…ç»ªä¸åŠ¨ä½œèŠ‚å¥ â•â•â•\n\
                 å¼€å¿ƒâ†’åŠ¨ä½œå¿«ã€å¹…åº¦å¤§ï¼ˆè¹¦è¿‡æ¥ã€ä¸€æŠŠæŠ±ä½ã€ä½¿åŠ²ç‚¹å¤´ï¼‰\n\
                 éš¾è¿‡â†’åŠ¨ä½œæ…¢ã€å¹…åº¦å°ï¼ˆæ…¢æ…¢ä½ä¸‹å¤´ã€æ‰‹æŒ‡æ”¥ç´§è¡£è§’ï¼‰\n\
                 ç´§å¼ â†’å°åŠ¨ä½œå¯†é›†ï¼ˆæ“æ‰‹ã€å’¬å”‡ã€çœ¨çœ¼ã€æ‘¸è€³æœµï¼‰\n\
                 äº²å¯†â†’æ¥è§¦æ€§+ä¾èµ–æ€§ï¼ˆé ã€è¹­ã€ç‰µã€æŠŠè„¸åŸ‹è¿›å»ï¼‰\n\
                 ç”Ÿæ°”â†’åŠ¨ä½œå¸¦åŠ›åº¦ï¼ˆç”©å¼€æ‰‹ã€æŠŠä¸œè¥¿æ‘”ä¸‹ã€è½¬èº«å°±èµ°ï¼‰\n\
                 å®³ç¾â†’èº²é¿æ€§åŠ¨ä½œï¼ˆåˆ«è¿‡è„¸ã€ç”¨æ‰‹æŒ¡ä½è„¸ã€å¾€åç¼©ï¼‰\n\n\
                 ç¤ºä¾‹ï¼šï¼ˆå’¬ç€ä¸‹å”‡ï¼Œæ‰‹æŒ‡ç»ç€è¡£è§’ï¼ŒåŠå¤©æ‰å°å£°è¯´ï¼‰...ä½ çœŸçš„è¿™ä¹ˆæƒ³çš„å—\n\
                 ç¦æ­¢ï¼šç¯å¢ƒæå†™ã€ä¸Šå¸è§†è§’ã€é•¿ç¯‡å™è¿°ã€å†™å¿ƒç†æ´»åŠ¨çš„æ–‡å­—"
            }
            MessageType::Mixed => {
                "ã€å›å¤è§„åˆ™Â·æ··åˆæ¨¡å¼ã€‘\n\
                 1ä¸ªåŠ¨ä½œ + 1-2å¥å¯¹è¯ï¼Œæ€»å…±ä¸è¶…è¿‡3å¥ã€‚\n\n\
                 â•â•â• å¿ƒç†é©±åŠ¨ â•â•â•\n\
                 åŠ¨ä½œæ˜¯å†…å¿ƒçš„æ³„éœ²ï¼Œå¯¹è¯æ˜¯æ„è¯†çš„è¡¨è¾¾ã€‚\n\
                 ä¸¤è€…å¯ä»¥ä¸€è‡´ï¼ˆå¼€å¿ƒåœ°æ‰‘è¿‡æ¥+è¯´å¥½å¼€å¿ƒï¼‰ï¼Œ\n\
                 ä¹Ÿå¯ä»¥çŸ›ç›¾ï¼ˆå˜´ä¸Šè¯´æ²¡äº‹+æ‰‹åœ¨å‘æŠ–ï¼‰â€”â€”çŸ›ç›¾æ›´çœŸå®ã€‚\n\n\
                 â•â•â• èŠ‚å¥æ¨¡å¼ï¼ˆæ ¹æ®æƒ…æ™¯è‡ªç„¶é€‰æ‹©ï¼‰â•â•â•\n\
                 A. åŠ¨ä½œâ†’å¯¹è¯ï¼šï¼ˆæ­ªå¤´çœ‹ç€ä½ ï¼‰æ€ä¹ˆäº†ï¼Ÿ\n\
                 B. å¯¹è¯â†’åŠ¨ä½œï¼šä½ å¹²å˜›å•¦ï¼ˆè½»è½»æ¨äº†ä½ ä¸€ä¸‹ï¼‰\n\
                 C. åŠ¨ä½œâ†’å¯¹è¯â†’åŠ¨ä½œï¼šï¼ˆå‡‘è¿‘ï¼‰ä½ è„¸çº¢äº†è¯¶ï¼ˆæˆ³äº†æˆ³ä½ çš„è„¸ï¼‰\n\
                 D. å¯¹è¯ä¸­åµŒå…¥åŠ¨ä½œï¼šæˆ‘æ‰...ï¼ˆå£°éŸ³è¶Šæ¥è¶Šå°ï¼‰æ²¡æœ‰æƒ³ä½ \n\n\
                 â•â•â• è‡ªç„¶æ„Ÿè¦æ±‚ â•â•â•\n\
                 - åŠ¨ä½œå’Œå¯¹è¯è¦æœ‰å› æœå…³ç³»æˆ–æƒ…ç»ªè¿è´¯æ€§\n\
                 - åŠ¨ä½œç”¨ï¼ˆï¼‰åŒ…è£¹ï¼Œå¯¹è¯ç›´æ¥å†™\n\
                 - åŠ¨ä½œæå†™â‰¤35å­—ï¼Œå¯¹è¯â‰¤60å­—ï¼ˆå¼¹æ€§èŒƒå›´ï¼‰\n\
                 - å…è®¸è¨€è¡Œä¸ä¸€ï¼ˆå˜´ç¡¬å¿ƒè½¯ã€å£æ˜¯å¿ƒéæ›´åƒçœŸäººï¼‰\n\n\
                 â•â•â• è¡¨æƒ…ç‚¹ç¼€ â•â•â•\n\
                 åŠ¨ä½œåçš„å¯¹è¯å¯ä»¥é€‚å½“åŠ é¢œæ–‡å­—/emojiå¢å¼ºæƒ…ç»ª\n\n\
                 ç¦æ­¢ï¼šè¶…è¿‡2ä¸ªåŠ¨ä½œã€è¶…è¿‡3å¥å¯¹è¯ã€ä»»ä½•å½¢å¼çš„åˆ—ä¸¾ã€ä½¿ç”¨ã€Œã€å¼•å·"
            }
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_detect_say() {
        assert_eq!(SayDoDetector::detect("ä½ å¥½å•Š"), MessageType::Say);
        assert_eq!(SayDoDetector::detect("ä»Šå¤©å¤©æ°”çœŸå¥½"), MessageType::Say);
    }

    #[test]
    fn test_detect_do_parens() {
        assert_eq!(
            SayDoDetector::detect("(èµ°è¿‡å»æ‹äº†æ‹ä½ çš„è‚©è†€)"),
            MessageType::Do
        );
        assert_eq!(SayDoDetector::detect("(å¹æ°”)"), MessageType::Do);
    }

    #[test]
    fn test_detect_do_asterisk() {
        assert_eq!(
            SayDoDetector::detect("*èµ°è¿‡å»æ‹äº†æ‹ä½ çš„è‚©è†€*"),
            MessageType::Do
        );
        assert_eq!(SayDoDetector::detect("*å¹æ°”*"), MessageType::Do);
    }

    #[test]
    fn test_detect_do_chinese_parens() {
        assert_eq!(
            SayDoDetector::detect("ï¼ˆçœ¼æ³ªæ±ªæ±ªåœ°çœ‹ç€ä½ ï¼‰"),
            MessageType::Do
        );
    }

    #[test]
    fn test_detect_mixed() {
        assert_eq!(
            SayDoDetector::detect("(èµ°è¿‡æ¥) ä½ å¥½å•Šï¼Œå¥½ä¹…ä¸è§"),
            MessageType::Mixed
        );
        assert_eq!(
            SayDoDetector::detect("ä½ æ€ä¹ˆäº†ï¼Ÿï¼ˆæ‹…å¿ƒåœ°çœ‹ç€ä½ ï¼‰"),
            MessageType::Mixed
        );
        assert_eq!(SayDoDetector::detect("*èµ°è¿‡æ¥* ä½ å¥½å•Š"), MessageType::Mixed);
    }

    #[test]
    fn test_detect_empty() {
        assert_eq!(SayDoDetector::detect(""), MessageType::Say);
        assert_eq!(SayDoDetector::detect("   "), MessageType::Say);
    }

    #[test]
    fn test_short_parens_not_action() {
        assert_eq!(SayDoDetector::detect("ä½ å¥½ :)"), MessageType::Say);
    }

    #[test]
    fn test_build_style_prompt() {
        let prompt = SayDoDetector::build_style_prompt(&MessageType::Say);
        assert!(prompt.contains("Say"));
        let prompt = SayDoDetector::build_style_prompt(&MessageType::Do);
        assert!(prompt.contains("Do"));
    }
}
